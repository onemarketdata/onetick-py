# Contributing and developing guide

## Source code

You should already have been given the access to <https://gitlab.sol.onetick.com/>.

Use `git clone --recursive` command to download source code of `onetick-py` and its submodules locally.

### Windows

`onetick-py` project has some symbolic links in its source code.

Symbolic links don't work on Windows by default
(more info here <https://github.com/git-for-windows/git/wiki/Symbolic-Links>).

To enable them, you need to configure git appropriately:

```bash
git clone -c core.symlinks=true --recursive ...
```

## Versioning

In `onetick-py` project we use semantic versioning similar to the one described in <https://semver.org>,
but with some differences.

We use version consisting from three digits: major, minor and patch version:

- *major* version is reserved to be updated manually only when some global project milestones are achieved
- *minor* version is used to create new releases
- *patch* version is used to apply fixes to those releases

## Release process

In `onetick-py` project we have semi-automatic release process.

Each commit to default branch has a manual button to run Gitlab CI/CD job
that will create new release by doing the following:

- incrementing *minor* version (e.g. version 1.2.0 will become 1.3.0)
- updating changelog file with the new section
- adding new tag with this version to git
- creating release branch in the format `release/major.minor.x` (e.g. release/1.3.x)
- adding new release entry to
  [Gitlab Releases page](https://gitlab.sol.onetick.com/solutions/py-onetick/onetick-py/-/releases)
- deploying new version of code and documentation to pip server and documentation server.

Each commit to the release branch also has a manual button to run Gitlab CI/CD job
that will apply a fix to the release by doing the following:

- incrementing *patch* version (e.g. version 1.3.0 will become 1.3.1)
- updating changelog file with the new section
- adding new tag with this version to git
- updating existing release entry in
  [Gitlab Releases page](https://gitlab.sol.onetick.com/solutions/py-onetick/onetick-py/-/releases)
- deploying new version of code and documentation to pip server and documentation server.

## Changelog

Every merge request that introduce some user-facing changes should be extended with changelog.

New changelog messages should be put ***only*** into the `## [Unreleased]` section
of the [CHANGELOG.md](CHANGELOG.md) file.

After new release comes out,
this section will be automatically renamed to the corresponding release version,
and the new version of the changelog file will be commited to default or release branch.

We use the same format for subsections' names as described here <https://keepachangelog.com>.
We have one special subsection name `### Backward incompatible changes`.

## Doctest

- We run doctests using the pytest, it has a corresponding extention.
  We use common context of globals with goal to simplify examples.
  For intstance, we extend the context with the `otp` object
  to prevent writing `import onetick.py as otp` for every example.
  The pytest proposes the `doctest_namespace` fixture to extend globals.
  In our package we define it in the `./onetick/py/conftest.py`.
  If you want to use a 3rd party module in examples, then it is the good place to define.
  The default `otp.Session` is also defined there with predefined databases that available in all examples.
  Please, extend existing databases or add new in defined there session.
- We collect all examples in docstrings and prepare jupiter snippets.
  We treat snippet as set of consecutive doctest.Example without output (only last doctestExample may have an output).
  To provide readable autogenerated documentation/snippets we skip doctest test setup and cleanup
- The doctest resources (external otqs, csv, configs ...) are situated in the `./doctest\_resources` folder;
  the otp.Session includes it in the `./onetick/py/conftest.py`

### Documentation rules

- enum parameters should be string; for example for type of joins use 'outer', 'inner', 'left'
- every new public feature should be documented in the doc\_sphinx/api

### Snippets rules

- nameless snippets would not be added
- Snippet should have unique name (`docs(snippets)` ci job checks that)
- It is better to skip snippet setup/output

### Format recommendations

- do not need to specify default value in the `Parameters` section because default values are visible in interface.
  Drawback: if default value is changed, then we will need to update doc.
  The same is about optional due the same reasons
- reference to parameter or constant should be wrapped into double backquotes `` ` ``
- reference to the 3rd party web sites: conf.py (the `extlink` option) and example in the Source.head
- use the `Returns` section in pydocs instead of annotation, because annotations generate ugly names
  (It doesn't mean that you should not add return type annotation)
- try to use links to other classes and functions

### How-To

- give name to a snippet - use directive `# OTdirective: snippet-name: <example_name>;`
- drop docstring.Example from documentation (but not from test execution) - `# OTdirective: skip-example: ;`
- nested names - it is better to name snippets with similar logic using nested names:
  for instance `mean` and `vwap` aggregations can be named as `Source.aggregations.mean` and `Source.aggregations.vwap`
  in this case snippets will be generated in dropdown Source -> aggregations

## Multiple Python versions support

- We support multiple python versions **3.9, 3.10, 3.11, 3.12, 3.13**.
  But python version **3.12** is used for development and testing.
- Keep in mind that some features are available only for specific versions.
  We collected backports in the `./onetick/py/backports.py` file,
  so you can use it in your code to DRY with imports like `from onetick.py.backports import Literal`.
- Current backported entities is: `Literal`, `zoneinfo`, `cached_property`, `ast.unparse()`
  replaced with `astunparse()`, `singledispatchmethod`.
  Add your backports there for the future usage by other, and update `CONTRIBUTING.md` file as well.

## Documentation suggestions

- start with the simplest example illustrating the most common functionality
- try to come up with (simple) examples based on business cases
- do not assume any knowledge of OneTick / don't use OneTick jargon (e.g., EP names)
- use `otp.run(q, ...)` in the examples as opposed to `q.to_df()`, `q()`, etc
- spell check
- give intuitive names to variables
